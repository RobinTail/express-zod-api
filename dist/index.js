import{clone as Jt,fromPairs as zo,map as wo,pipe as Io,toPairs as Zo,pair as Eo}from"ramda";import{z as le}from"zod";import{isHttpError as xo}from"http-errors";import{pickBy as bo,xprod as So}from"ramda";import{z as To}from"zod";var ce=class extends Error{name="RoutingError"},Z=class extends Error{name="DocumentationError";constructor({message:t,method:r,path:o,isResponse:n}){let i=`${t}
Caused by ${n?"response":"input"} schema of an Endpoint assigned to ${r.toUpperCase()} method of ${o} path.`;super(i)}},He=class extends Error{name="IOSchemaError"},G=class extends He{constructor(r){super(H(r));this.originalError=r}name="OutputValidationError"},k=class extends He{constructor(r){super(H(r));this.originalError=r}name="InputValidationError"},U=class extends Error{constructor(r,o){super(r);this.originalError=o}name="ResultHandlerError"},Pe=class extends Error{name="MissingPeerError";constructor(t){super(`Missing peer dependency: ${t}. Please install it to use the feature.`)}};var R={json:"application/json",upload:"multipart/form-data",raw:"application/octet-stream"};var Oo=e=>{let r=(e.header("content-type")||"").toLowerCase().startsWith(R.upload);return"files"in e&&r},mt={get:["query","params"],post:["body","params","files"],put:["body","params"],patch:["body","params"],delete:["query","params"]},Ro=["body","query","params"],ut=e=>e.method.toLowerCase(),ft=e=>e.startsWith("x-"),Ao=e=>bo((t,r)=>ft(r),e),De=(e,t={})=>{let r=ut(e);return r==="options"?{}:(t[r]||mt[r]||Ro).filter(o=>o==="files"?Oo(e):!0).map(o=>o==="headers"?Ao(e[o]):e[o]).reduce((o,n)=>({...o,...n}),{})},de=e=>e instanceof Error?e:new Error(String(e)),H=e=>e instanceof To.ZodError?e.issues.map(({path:t,message:r})=>(t.length?[t.join("/")]:[]).concat(r).join(": ")).join("; "):e instanceof G?`output${e.originalError.issues[0]?.path.length>0?"/":": "}${e.message}`:e.message,Ke=e=>xo(e)?e.statusCode:e instanceof k?400:500,yt=({logger:e,request:t,input:r,error:o,statusCode:n})=>{n===500&&e.error(`Internal server error
${o.stack}
`,{url:t.url,payload:r})},D=({schema:e,variant:t="original",validate:r=t==="parsed"})=>{let o=e._def[g]?.examples||[];if(!r&&t==="original")return o;let n=[];for(let i of o){let a=e.safeParse(i);a.success&&n.push(t==="parsed"?a.data:i)}return n},_=(e,t,r)=>e.length&&t.length?So(e,t).map(r):e.concat(t),Ce=e=>"coerce"in e._def&&typeof e._def.coerce=="boolean"?e._def.coerce:!1,gt=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),E=(...e)=>e.flatMap(t=>t.split(/[^A-Z0-9]/gi)).flatMap(t=>t.replaceAll(/[A-Z]+/g,r=>`/${r}`).split("/")).map(gt).join(""),Fe=(e,t)=>{try{return typeof e.parse(t)}catch{return}},Y=e=>typeof e=="object"&&e!==null;import{clone as Po,mergeDeepRight as Co}from"ramda";var g=Symbol.for("express-zod-api"),Be=e=>{let t=e.describe(e.description);return t._def[g]=Po(t._def[g])||{examples:[]},t},Qt=(e,t)=>{if(!(g in e._def))return t;let r=Be(t);return r._def[g].examples=_(r._def[g].examples,e._def[g].examples,([o,n])=>typeof o=="object"&&typeof n=="object"?Co({...o},{...n}):n),r};var vo=function(e){let t=Be(this);return t._def[g].examples.push(e),t},jo=function(e){let t=Be(this);return t._def[g].defaultLabel=e,t},Lo=function(e){return new le.ZodBranded({typeName:le.ZodFirstPartyTypeKind.ZodBranded,type:this,description:this._def.description,errorMap:this._def.errorMap,[g]:{examples:[],...Jt(this._def[g]),brand:e}})},No=function(e){let t=typeof e=="function"?e:Io(Zo,wo(([n,i])=>Eo(e[String(n)]||n,i)),zo),r=t(Jt(this.shape)),o=le.object(r)[this._def.unknownKeys]();return this.transform(t).pipe(o)};g in globalThis||(globalThis[g]=!0,Object.defineProperties(le.ZodType.prototype,{example:{get(){return vo.bind(this)}},brand:{set(){},get(){return Lo.bind(this)}}}),Object.defineProperty(le.ZodDefault.prototype,"label",{get(){return jo.bind(this)}}),Object.defineProperty(le.ZodObject.prototype,"remap",{get(){return No.bind(this)}}));function ko(e){return e}import{z as $o}from"zod";import{z as ar}from"zod";import{fail as A}from"node:assert/strict";import{z as ze}from"zod";var qe=e=>!isNaN(e.getTime());var Q=Symbol("DateIn"),Wt=()=>ze.union([ze.string().date(),ze.string().datetime(),ze.string().datetime({local:!0})]).transform(t=>new Date(t)).pipe(ze.date().refine(qe)).brand(Q);import{z as Mo}from"zod";var J=Symbol("DateOut"),Xt=()=>Mo.date().refine(qe).transform(e=>e.toISOString()).brand(J);import{z as $e}from"zod";var j=Symbol("File"),er=$e.custom(e=>Buffer.isBuffer(e),{message:"Expected Buffer"}),Uo={buffer:()=>er.brand(j),string:()=>$e.string().brand(j),binary:()=>er.or($e.string()).brand(j),base64:()=>$e.string().base64().brand(j)};function Ve(e){return Uo[e||"string"]()}import{z as Ho}from"zod";var K=Symbol("Raw"),tr=(e={})=>Ho.object({raw:Ve("buffer")}).extend(e).brand(K);import{z as Do}from"zod";var me=Symbol("Upload"),rr=()=>Do.custom(e=>typeof e=="object"&&e!==null&&"name"in e&&"encoding"in e&&"mimetype"in e&&"data"in e&&"tempFilePath"in e&&"truncated"in e&&"size"in e&&"md5"in e&&"mv"in e&&typeof e.name=="string"&&typeof e.encoding=="string"&&typeof e.mimetype=="string"&&Buffer.isBuffer(e.data)&&typeof e.tempFilePath=="string"&&typeof e.truncated=="boolean"&&typeof e.size=="number"&&typeof e.md5=="string"&&typeof e.mv=="function",e=>({message:`Expected file upload, received ${typeof e}`})).brand(me);var or=(e,{next:t})=>e.options.some(t),Ko=({_def:e},{next:t})=>[e.left,e.right].some(t),Ge=(e,{next:t})=>t(e.unwrap()),ht={ZodObject:({shape:e},{next:t})=>Object.values(e).some(t),ZodUnion:or,ZodDiscriminatedUnion:or,ZodIntersection:Ko,ZodEffects:(e,{next:t})=>t(e.innerType()),ZodOptional:Ge,ZodNullable:Ge,ZodRecord:({valueSchema:e},{next:t})=>t(e),ZodArray:({element:e},{next:t})=>t(e),ZodDefault:({_def:e},{next:t})=>t(e.innerType)},_e=(e,{condition:t,rules:r=ht,depth:o=1,maxDepth:n=Number.POSITIVE_INFINITY})=>{if(t?.(e))return!0;let i=o<n?r[e._def[g]?.brand]||r[e._def.typeName]:void 0;return i?i(e,{next:a=>_e(a,{condition:t,rules:r,maxDepth:n,depth:o+1})}):!1},nr=e=>_e(e,{condition:t=>t._def[g]?.brand===me}),sr=e=>_e(e,{condition:t=>t._def[g]?.brand===K,maxDepth:3}),xt=(e,t)=>{let r=new WeakSet;return _e(e,{maxDepth:300,rules:{...ht,ZodBranded:Ge,ZodReadonly:Ge,ZodCatch:({_def:{innerType:o}},{next:n})=>n(o),ZodPipeline:({_def:o},{next:n})=>n(o[t]),ZodLazy:(o,{next:n})=>r.has(o)?!1:r.add(o)&&n(o.schema),ZodTuple:({items:o,_def:{rest:n}},{next:i})=>[...o].concat(n??[]).some(i),ZodEffects:{out:void 0,in:ht.ZodEffects}[t],ZodNaN:()=>A("z.nan()"),ZodSymbol:()=>A("z.symbol()"),ZodFunction:()=>A("z.function()"),ZodMap:()=>A("z.map()"),ZodSet:()=>A("z.set()"),ZodBigInt:()=>A("z.bigint()"),ZodVoid:()=>A("z.void()"),ZodPromise:()=>A("z.promise()"),ZodNever:()=>A("z.never()"),ZodDate:()=>t==="in"&&A("z.date()"),[J]:()=>t==="in"&&A("ez.dateOut()"),[Q]:()=>t==="out"&&A("ez.dateIn()"),[K]:()=>t==="out"&&A("ez.raw()"),[me]:()=>t==="out"&&A("ez.upload()"),[j]:()=>!1}})};var Ye=({error:e,logger:t,response:r})=>{t.error(`Result handler failure: ${e.message}.`),r.status(500).type("text/plain").end(`An error occurred while serving the result: ${e.message}.`+(e.originalError?`
Original error: ${e.originalError.message}.`:""))};import{chain as Fo}from"ramda";var W=e=>Y(e)&&"or"in e,fe=e=>Y(e)&&"and"in e,bt=e=>({and:Fo(t=>fe(t)?t.and:[t],e)}),Qe=(e,t)=>fe(e)?{and:e.and.map(r=>W(r)?{or:r.or.map(t)}:t(r))}:W(e)?{or:e.or.map(r=>fe(r)?{and:r.and.map(t)}:t(r))}:t(e),St=e=>e.and.reduce((t,r)=>({or:_(t.or,W(r)?r.or:[r],bt)}),{or:[]}),ue=(e,t)=>fe(e)?W(t)?ue(St(e),t):bt([e,t]):W(e)?fe(t)?ue(t,e):W(t)?{or:_(e.or,t.or,bt)}:ue(e,{and:[t]}):fe(t)||W(t)?ue(t,e):{and:[e,t]};import{z as ir}from"zod";var Tt=class{},F=class extends Tt{#e;#t;#r;constructor({input:t,security:r,handler:o}){super(),this.#e=t,this.#t=r,this.#r=o}getSecurity(){return this.#t}getSchema(){return this.#e}async execute({input:t,...r}){try{let o=await this.#e.parseAsync(t);return this.#r({...r,input:o})}catch(o){throw o instanceof ir.ZodError?new k(o):o}}},ye=class extends F{constructor(t,{provider:r=()=>({}),transformer:o=n=>n}={}){super({input:ir.object({}),handler:async({request:n,response:i})=>new Promise((a,p)=>{let d=c=>{if(c&&c instanceof Error)return p(o(c));a(r(n,i))};t(n,i,d)?.catch(d)})})}};var we=class{},Je=class extends we{#e;#t;#r;#i;#o;#a;#p;#n;#c;#d;#l;#s;constructor({methods:t,inputSchema:r,outputSchema:o,handler:n,resultHandler:i,getOperationId:a=()=>{},scopes:p=[],middlewares:d=[],tags:c=[],description:m,shortDescription:l}){super(),this.#a=n,this.#p=i,this.#r=d,this.#l=a,this.#t=Object.freeze(t),this.#c=Object.freeze(p),this.#d=Object.freeze(c),this.#e={long:m,short:l},this.#n={input:r,output:o},this.#o={positive:Object.freeze(i.getPositiveResponse(o)),negative:Object.freeze(i.getNegativeResponse())},this.#s=nr(r)?"upload":sr(r)?"raw":"json",this.#i={input:Object.freeze([R[this.#s]]),positive:Object.freeze(this.#o.positive.flatMap(({mimeTypes:u})=>u)),negative:Object.freeze(this.#o.negative.flatMap(({mimeTypes:u})=>u))}}getDescription(t){return this.#e[t]}getMethods(){return this.#t}getSchema(t){return t==="input"||t==="output"?this.#n[t]:this.getResponses(t).map(({schema:r})=>r).reduce((r,o)=>r.or(o))}getMimeTypes(t){return this.#i[t]}getRequestType(){return this.#s}getResponses(t){return this.#o[t]}getSecurity(){return this.#r.reduce((t,r)=>{let o=r.getSecurity();return o?ue(t,o):t},{and:[]})}getScopes(){return this.#c}getTags(){return this.#d}getOperationId(t){return this.#l(t)}#m(t){return{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":this.#t.concat(t).concat("options").join(", ").toUpperCase(),"Access-Control-Allow-Headers":"content-type"}}async#u(t){try{return await this.#n.output.parseAsync(t)}catch(r){throw r instanceof ar.ZodError?new G(r):r}}async#f({method:t,input:r,request:o,response:n,logger:i,options:a}){for(let p of this.#r)if(!(t==="options"&&!(p instanceof ye))&&(Object.assign(a,await p.execute({input:r,options:a,request:o,response:n,logger:i})),n.writableEnded)){i.warn("A middleware has closed the stream. Accumulated options:",a);break}}async#y({input:t,options:r,logger:o}){let n;try{n=await this.#n.input.parseAsync(t)}catch(i){throw i instanceof ar.ZodError?new k(i):i}return this.#a({input:n,options:r,logger:o})}async#g({error:t,request:r,response:o,logger:n,input:i,output:a,options:p}){try{await this.#p.execute({error:t,output:a,request:r,response:o,logger:n,input:i,options:p})}catch(d){Ye({logger:n,response:o,error:new U(de(d).message,t||void 0)})}}async execute({request:t,response:r,logger:o,config:n,siblingMethods:i=[]}){let a=ut(t),p={},d=null,c=null;if(n.cors){let l=this.#m(i);typeof n.cors=="function"&&(l=await n.cors({request:t,logger:o,endpoint:this,defaultHeaders:l}));for(let u in l)r.set(u,l[u])}let m=De(t,n.inputSources);try{if(await this.#f({method:a,input:m,request:t,response:r,logger:o,options:p}),r.writableEnded)return;if(a==="options"){r.status(200).end();return}d=await this.#u(await this.#y({input:m,logger:o,options:p}))}catch(l){c=de(l)}await this.#g({input:m,output:d,request:t,response:r,error:c,logger:o,options:p})}};var pr=(e,t)=>{let r=e.map(n=>n.getSchema()).concat(t),o=r.reduce((n,i)=>n.and(i));return r.reduce((n,i)=>Qt(i,n),o)};import{z as L}from"zod";var X={positive:200,negative:400};import Bo from"node:assert/strict";import{z as qo}from"zod";var We=(e,t)=>typeof e=="function"?We(e(...t.arguments),t):e instanceof qo.ZodType?[{...t,schema:e}]:(Array.isArray(e)&&Bo(e.length,new U(`At least one ${t.variant} response schema required.`)),(Array.isArray(e)?e:[e]).map(({schema:r,statusCodes:o,statusCode:n,mimeTypes:i,mimeType:a})=>({schema:r,statusCodes:n?[n]:o||t.statusCodes,mimeTypes:a?[a]:i||t.mimeTypes})));var Ot=class{#e;constructor(t){this.#e=t}execute(...t){return this.#e(...t)}},Ie=class extends Ot{#e;#t;constructor(t){super(t.handler),this.#e=t.positive,this.#t=t.negative}getPositiveResponse(t){return We(this.#e,{variant:"positive",arguments:[t],statusCodes:[X.positive],mimeTypes:[R.json]})}getNegativeResponse(){return We(this.#t,{variant:"negative",arguments:[],statusCodes:[X.negative],mimeTypes:[R.json]})}},Ze=new Ie({positive:e=>{let t=D({schema:e}),r=L.object({status:L.literal("success"),data:e});return t.reduce((o,n)=>o.example({status:"success",data:n}),r)},negative:L.object({status:L.literal("error"),error:L.object({message:L.string()})}).example({status:"error",error:{message:H(new Error("Sample error message"))}}),handler:({error:e,input:t,output:r,request:o,response:n,logger:i})=>{if(!e){n.status(X.positive).json({status:"success",data:r});return}let a=Ke(e);yt({logger:i,statusCode:a,request:o,error:e,input:t}),n.status(a).json({status:"error",error:{message:H(e)}})}}),Rt=new Ie({positive:e=>{let t=D({schema:e}),r="shape"in e&&"items"in e.shape&&e.shape.items instanceof L.ZodArray?e.shape.items:L.array(L.any());return t.reduce((o,n)=>Y(n)&&"items"in n&&Array.isArray(n.items)?o.example(n.items):o,r)},negative:L.string().example(H(new Error("Sample error message"))),handler:({response:e,output:t,error:r,logger:o,request:n,input:i})=>{if(r){let a=Ke(r);yt({logger:o,statusCode:a,request:n,error:r,input:i}),e.status(a).type("text/plain").send(r.message);return}t&&"items"in t&&Array.isArray(t.items)?e.status(X.positive).json(t.items):e.status(500).type("text/plain").send("Property 'items' is missing in the endpoint output")}});var Ee=class e{resultHandler;middlewares=[];constructor(t){this.resultHandler="resultHandler"in t?t.resultHandler:t}static#e(t,r){let o=new e(r);return o.middlewares=t,o}addMiddleware(t){return e.#e(this.middlewares.concat(t instanceof F?t:new F(t)),this.resultHandler)}use=this.addExpressMiddleware;addExpressMiddleware(...t){return e.#e(this.middlewares.concat(new ye(...t)),this.resultHandler)}addOptions(t){return e.#e(this.middlewares.concat(new F({input:$o.object({}),handler:t})),this.resultHandler)}build({input:t,handler:r,output:o,description:n,shortDescription:i,operationId:a,...p}){let{middlewares:d,resultHandler:c}=this,m="methods"in p?p.methods:[p.method],l=typeof a=="function"?a:()=>a,u="scopes"in p?p.scopes:"scope"in p&&p.scope?[p.scope]:[],S="tags"in p?p.tags:"tag"in p&&p.tag?[p.tag]:[];return new Je({handler:r,middlewares:d,outputSchema:o,resultHandler:c,scopes:u,tags:S,methods:m,getOperationId:l,description:n,shortDescription:i,inputSchema:pr(d,t)})}},Vo=new Ee(Ze),Go=new Ee(Rt);import{Ansis as Yo,blue as Qo,cyanBright as Jo,green as Wo,hex as Xo,red as en}from"ansis";import{inspect as tn}from"node:util";import{performance as yr}from"node:perf_hooks";var et={debug:10,info:20,warn:30,error:40},dr=e=>Y(e)&&Object.keys(et).some(t=>t in e),lr=e=>e in et,mr=(e,t)=>et[e]<et[t],ur=(e=0)=>Intl.NumberFormat(void 0,{useGrouping:!1,minimumFractionDigits:0,maximumFractionDigits:e}),Xe=ur(),cr=ur(2),_o=e=>e<1e-6?["picosecond",e/1e-9,Xe]:e<.001?["nanosecond",e/1e-6,Xe]:e<1?["microsecond",e/.001,Xe]:e<1e3?["millisecond",e,Xe]:e<6e4?["second",e/1e3,cr]:["minute",e/6e4,cr],fr=e=>{let[t,r,o]=_o(e);return`${o.format(r)} ${t}${r>1?"s":""}`};var ve=class e{constructor(t){this.config=t;let{color:r=new Yo().isSupported()}=t;this.hasColor=r}hasColor;styles={debug:Qo,info:Wo,warn:Xo("#FFA500"),error:en};prettyPrint(t){let{depth:r=2}=this.config;return tn(t,{depth:r,colors:this.hasColor,breakLength:this.config.level==="debug"?80:1/0,compact:this.config.level==="debug"?3:!0})}print(t,r,o){if(this.config.level==="silent"||mr(t,this.config.level))return;let{requestId:n,...i}=this.config.ctx||{},a=[new Date().toISOString()];n&&a.push(this.hasColor?Jo(n):n),a.push(this.hasColor?`${this.styles[t](t)}:`:`${t}:`,r),o!==void 0&&a.push(this.prettyPrint(o)),Object.keys(i).length>0&&a.push(this.prettyPrint(i)),console.log(a.join(" "))}debug(t,r){this.print("debug",t,r)}info(t,r){this.print("info",t,r)}warn(t,r){this.print("warn",t,r)}error(t,r){this.print("error",t,r)}child(t){return new e({...this.config,ctx:t})}profile(t){let r=yr.now();return()=>{let o=yr.now()-r,{message:n,severity:i="debug",formatter:a=fr}=typeof t=="object"?t:{message:t};this.print(typeof i=="function"?i(o):i,n,a(o))}}};import{head as rn,tail as on,toPairs as nn}from"ramda";var je=class{pairs;firstEndpoint;siblingMethods;constructor(t){this.pairs=Object.freeze(nn(t).filter(r=>r!==void 0&&r[1]!==void 0)),this.firstEndpoint=rn(this.pairs)?.[1],this.siblingMethods=Object.freeze(on(this.pairs).map(([r])=>r))}};import sn from"express";var Le=class{params;constructor(...t){this.params=t}apply(t,r){return r(t,sn.static(...this.params))}};import Pt from"express";import un from"node:http";import fn from"node:https";var ge=async(e,t="default")=>{try{return(await import(e))[t]}catch{}throw new Pe(e)};import gr from"node:assert/strict";var ee=({routing:e,onEndpoint:t,onStatic:r,parentPath:o,hasCors:n})=>{let i=Object.entries(e).map(([a,p])=>[a.trim(),p]);for(let[a,p]of i){gr.doesNotMatch(a,/\//,new ce(`The entry '${a}' must avoid having slashes \u2014 use nesting instead.`));let d=`${o||""}${a?`/${a}`:""}`;if(p instanceof we){let c=p.getMethods().slice();n&&c.push("options");for(let m of c)t(p,d,m)}else if(p instanceof Le)r&&p.apply(d,r);else if(p instanceof je){for(let[c,m]of p.pairs)gr(m.getMethods().includes(c),new ce(`Endpoint assigned to ${c} method of ${d} must support ${c} method.`)),t(m,d,c);n&&p.firstEndpoint&&t(p.firstEndpoint,d,"options",p.siblingMethods)}else ee({onEndpoint:t,onStatic:r,hasCors:n,routing:p,parentPath:d})}};var At=({app:e,rootLogger:t,getChildLogger:r,config:o,routing:n,parsers:i})=>{let a=new WeakSet;ee({routing:n,hasCors:!!o.cors,onEndpoint:(p,d,c,m)=>{let l=p.getRequestType();if(!a.has(p)){if(l==="json")try{xt(p.getSchema("input"),"in")}catch(u){t.warn("The final input schema of the endpoint contains an unsupported JSON payload type.",{path:d,method:c,reason:u})}for(let u of["positive","negative"])if(p.getMimeTypes(u).includes(R.json))try{xt(p.getSchema("output"),"out")}catch(S){t.warn(`The final ${u} response schema of the endpoint contains an unsupported JSON payload type.`,{path:d,method:c,reason:S})}a.add(p)}e[c](d,...i?.[l]||[],async(u,S)=>p.execute({request:u,response:S,logger:r(u),config:o,siblingMethods:m}))},onStatic:(p,d)=>{e.use(p,d)}})};import Rr,{isHttpError as pn}from"http-errors";import{setInterval as an}from"node:timers/promises";var hr=e=>"_httpMessage"in e&&typeof e._httpMessage=="object"&&e._httpMessage!==null&&"headersSent"in e._httpMessage&&typeof e._httpMessage.headersSent=="boolean"&&"setHeader"in e._httpMessage&&typeof e._httpMessage.setHeader=="function",xr=e=>"server"in e&&typeof e.server=="object"&&e.server!==null&&"close"in e.server&&typeof e.server.close=="function",br=e=>"encrypted"in e&&typeof e.encrypted=="boolean"&&e.encrypted,Sr=({},e)=>void(!e.headersSent&&e.setHeader("connection","close")),Tr=e=>new Promise((t,r)=>void e.close(o=>o?r(o):t()));var Or=(e,{timeout:t=1e3,logger:r}={})=>{let o,n=new Set,i=c=>void n.delete(c.destroy()),a=c=>void(hr(c)?!c._httpMessage.headersSent&&c._httpMessage.setHeader("connection","close"):i(c)),p=c=>void(o?c.destroy():n.add(c.once("close",()=>void n.delete(c))));for(let c of e)for(let m of["connection","secureConnection"])c.on(m,p);let d=async()=>{for(let c of e)c.on("request",Sr);r?.info("Graceful shutdown",{sockets:n.size,timeout:t});for(let c of n)(br(c)||xr(c))&&a(c);for await(let c of an(10,Date.now()))if(n.size===0||Date.now()-c>=t)break;for(let c of n)i(c);return Promise.allSettled(e.map(Tr))};return{sockets:n,shutdown:()=>o??=d()}};var Ar=({errorHandler:e,getChildLogger:t})=>async(r,o,n,i)=>r?e.execute({error:pn(r)?r:Rr(400,de(r).message),request:o,response:n,input:null,output:null,options:{},logger:t(o)}):i(),Pr=({errorHandler:e,getChildLogger:t})=>async(r,o)=>{let n=Rr(404,`Can not ${r.method} ${r.path}`),i=t(r);try{e.execute({request:r,response:o,logger:i,error:n,input:null,output:null,options:{}})}catch(a){Ye({response:o,logger:i,error:new U(de(a).message,n)})}},cn=e=>(t,{},r)=>{if(Object.values(t?.files||[]).flat().find(({truncated:n})=>n))return r(e);r()},dn=e=>({log:e.debug.bind(e)}),Cr=async({getChildLogger:e,config:t})=>{let r=await ge("express-fileupload"),{limitError:o,beforeUpload:n,...i}={...typeof t.server.upload=="object"&&t.server.upload},a=[];return a.push(async(p,d,c)=>{let m=e(p);try{await n?.({request:p,logger:m})}catch(l){return c(l)}return r({debug:!0,...i,abortOnLimit:!1,parseNested:!0,logger:dn(m)})(p,d,c)}),o&&a.push(cn(o)),a},zr=(e,{},t)=>{Buffer.isBuffer(e.body)&&(e.body={raw:e.body}),t()},wr=({rootLogger:e,config:t})=>async(r,o,n)=>{let i=t.childLoggerProvider?await t.childLoggerProvider({request:r,parent:e}):e;i.debug(`${r.method}: ${r.path}`),r.res&&(r.res.locals[g]={logger:i}),n()},Ir=e=>t=>t.res?.locals[g]?.logger||e,Zr=e=>process.on("deprecation",({message:t,namespace:r,name:o,stack:n})=>e.warn(`${o} (${r}): ${t}`,n.split(`
`).slice(1))),Er=({servers:e,logger:t,options:{timeout:r,events:o=["SIGINT","SIGTERM"]}})=>{let n=Or(e,{logger:t,timeout:r}),i=()=>n.shutdown().then(()=>process.exit());for(let a of o)process.on(a,i)};import{gray as ln,hex as vr,italic as tt,whiteBright as mn}from"ansis";var jr=()=>{let e=tt("Proudly supports transgender community.".padStart(109)),t=tt("Start your API server with I/O schema validation and custom middlewares in minutes.".padStart(109)),r=tt("Thank you for choosing Express Zod API for your project.".padStart(132)),o=tt("for Zoey".padEnd(20)),n=vr("#F5A9B8"),i=vr("#5BCEFA"),a=new Array(14).fill(i,1,3).fill(n,3,5).fill(mn,5,7).fill(n,7,9).fill(i,9,12).fill(ln,12,13);return`
8888888888                                                          8888888888P              888             d8888 8888888b. 8888888
888                                                                       d88P               888            d88888 888   Y88b  888
888                                                                      d88P                888           d88P888 888    888  888
8888888    888  888 88888b.  888d888 .d88b.  .d8888b  .d8888b           d88P    .d88b.   .d88888          d88P 888 888   d88P  888
888        \u1FEFY8bd8P' 888 "88b 888P"  d8P  Y8b 88K      88K              d88P    d88""88b d88" 888         d88P  888 8888888P"   888
888          X88K   888  888 888    88888888 "Y8888b. "Y8888b.        d88P     888  888 888  888        d88P   888 888         888
888        .d8""8b. 888 d88P 888    Y8b.          X88      X88       d88P      Y88..88P Y88b 888       d8888888888 888         888
8888888888 888  888 88888P"  888     "Y8888   88888P'  88888P'      d8888888888 "Y88P"   "Y88888      d88P     888 888       8888888
                    888
                    888${e}
${o}888${t}
${r}
`.split(`
`).map((d,c)=>a[c]?a[c](d):d).join(`
`)};var Lr=e=>{e.startupLogo!==!1&&console.log(jr());let t=e.errorHandler||Ze,r=dr(e.logger)?e.logger:new ve(e.logger);r.debug("Running","v20.15.2 (ESM)"),Zr(r);let o=wr({rootLogger:r,config:e}),i={getChildLogger:Ir(r),errorHandler:t},a=Pr(i),p=Ar(i);return{...i,rootLogger:r,notFoundHandler:a,parserFailureHandler:p,loggingMiddleware:o}},yn=(e,t)=>{let{rootLogger:r,getChildLogger:o,notFoundHandler:n,loggingMiddleware:i}=Lr(e);return At({app:e.app.use(i),rootLogger:r,routing:t,getChildLogger:o,config:e}),{notFoundHandler:n,logger:r}},gn=async(e,t)=>{let{rootLogger:r,getChildLogger:o,notFoundHandler:n,parserFailureHandler:i,loggingMiddleware:a}=Lr(e),p=Pt().disable("x-powered-by").use(a);if(e.server.compression){let u=await ge("compression");p.use(u(typeof e.server.compression=="object"?e.server.compression:void 0))}let d={json:[e.server.jsonParser||Pt.json()],raw:[e.server.rawParser||Pt.raw(),zr],upload:e.server.upload?await Cr({config:e,getChildLogger:o}):[]};e.server.beforeRouting&&await e.server.beforeRouting({app:p,logger:r,getChildLogger:o}),At({app:p,routing:t,rootLogger:r,getChildLogger:o,config:e,parsers:d}),p.use(i,n);let c=(u,S)=>u.listen(S,()=>r.info("Listening",S)),m=un.createServer(p),l=e.https&&fn.createServer(e.https.options,p);return e.gracefulShutdown&&Er({servers:[m].concat(l||[]),logger:r,options:e.gracefulShutdown===!0?{}:e.gracefulShutdown}),{app:p,logger:r,httpServer:c(m,e.server.listen),httpsServer:l&&c(l,e.https?.listen)}};import bs from"node:assert/strict";import{OpenApiBuilder as Ss}from"openapi3-ts/oas31";import{keys as Ts,pluck as Os}from"ramda";import oe from"node:assert/strict";import{isReferenceObject as zt,isSchemaObject as ot}from"openapi3-ts/oas31";import{concat as hn,type as Mr,filter as xn,fromPairs as Ne,has as bn,isNil as Sn,map as he,mergeAll as Tn,mergeDeepRight as On,mergeDeepWith as Rn,objOf as Ur,omit as nt,pipe as Hr,pluck as An,range as Pn,reject as Cn,toLower as zn,union as wn,when as In,xprod as st,zip as Zn}from"ramda";import{z as x}from"zod";var te=(e,{onEach:t,rules:r,onMissing:o,ctx:n={}})=>{let i=r[e._def[g]?.brand]||r[e._def.typeName],p=i?i(e,{...n,next:c=>te(c,{ctx:n,onEach:t,rules:r,onMissing:o})}):o(e,n),d=t&&t(e,{prev:p,...n});return d?{...p,...d}:p};var Nr=50,Dr="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString",En={integer:0,number:0,string:"",boolean:!1,object:{},null:null,array:[]},Kr=/:([A-Za-z0-9_]+)/g,vn=e=>e.match(Kr)?.map(t=>t.slice(1))||[],Fr=e=>e.replace(Kr,t=>`{${t.slice(1)}}`),jn=({_def:e},{next:t})=>({...t(e.innerType),default:e[g]?.defaultLabel||e.defaultValue()}),Ln=({_def:{innerType:e}},{next:t})=>t(e),Nn=()=>({format:"any"}),kn=({},e)=>(oe(!e.isResponse,new Z({message:"Please use ez.upload() only for input.",...e})),{type:"string",format:"binary"}),Mn=e=>{let t=e.unwrap();return{type:"string",format:t instanceof x.ZodString?t._def.checks.find(r=>r.kind==="base64")?"byte":"file":"binary"}},Un=({options:e},{next:t})=>({oneOf:e.map(t)}),Hn=({options:e,discriminator:t},{next:r})=>({discriminator:{propertyName:t},oneOf:e.map(r)}),Dn=e=>{let[t,r]=e.filter(ot).filter(n=>n.type==="object"&&Object.keys(n).every(i=>["type","properties","required","examples"].includes(i)));oe(t&&r,"Can not flatten objects");let o={type:"object"};return(t.properties||r.properties)&&(o.properties=Rn((n,i)=>Array.isArray(n)&&Array.isArray(i)?hn(n,i):n===i?i:oe.fail("Can not flatten properties"),t.properties||{},r.properties||{})),(t.required||r.required)&&(o.required=wn(t.required||[],r.required||[])),(t.examples||r.examples)&&(o.examples=_(t.examples||[],r.examples||[],([n,i])=>On(n,i))),o},Kn=({_def:{left:e,right:t}},{next:r})=>{let o=[e,t].map(r);try{return Dn(o)}catch{}return{allOf:o}},Fn=(e,{next:t})=>t(e.unwrap()),Bn=(e,{next:t})=>t(e.unwrap()),qn=(e,{next:t})=>{let r=t(e.unwrap());return ot(r)&&(r.type=qr(r)),r},Br=e=>{let t=zn(Mr(e));return typeof e=="bigint"?"integer":t==="number"||t==="string"||t==="boolean"||t==="object"||t==="null"||t==="array"?t:void 0},kr=e=>({type:Br(Object.values(e.enum)[0]),enum:Object.values(e.enum)}),$n=({value:e})=>({type:Br(e),const:e}),Vn=(e,{isResponse:t,next:r})=>{let o=Object.keys(e.shape),n=p=>t&&Ce(p)?p instanceof x.ZodOptional:p.isOptional(),i=o.filter(p=>!n(e.shape[p])),a={type:"object"};return o.length&&(a.properties=rt(e,r)),i.length&&(a.required=i),a},Gn=()=>({type:"null"}),_n=({},e)=>(oe(!e.isResponse,new Z({message:"Please use ez.dateOut() for output.",...e})),{description:"YYYY-MM-DDTHH:mm:ss.sssZ",type:"string",format:"date-time",pattern:/^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2}(\.\d+)?)?Z?$/.source,externalDocs:{url:Dr}}),Yn=({},e)=>(oe(e.isResponse,new Z({message:"Please use ez.dateIn() for input.",...e})),{description:"YYYY-MM-DDTHH:mm:ss.sssZ",type:"string",format:"date-time",externalDocs:{url:Dr}}),Qn=({},e)=>oe.fail(new Z({message:`Using z.date() within ${e.isResponse?"output":"input"} schema is forbidden. Please use ez.date${e.isResponse?"Out":"In"}() instead. Check out the documentation for details.`,...e})),Jn=()=>({type:"boolean"}),Wn=()=>({type:"integer",format:"bigint"}),Xn=e=>e.every(t=>t instanceof x.ZodLiteral),es=({keySchema:e,valueSchema:t},{next:r})=>{if(e instanceof x.ZodEnum||e instanceof x.ZodNativeEnum){let o=Object.values(e.enum),n={type:"object"};return o.length&&(n.properties=rt(x.object(Ne(st(o,[t]))),r),n.required=o),n}if(e instanceof x.ZodLiteral)return{type:"object",properties:rt(x.object({[e.value]:t}),r),required:[e.value]};if(e instanceof x.ZodUnion&&Xn(e.options)){let o=he(i=>`${i.value}`,e.options),n=Ne(st(o,[t]));return{type:"object",properties:rt(x.object(n),r),required:o}}return{type:"object",additionalProperties:r(t)}},ts=({_def:{minLength:e,maxLength:t},element:r},{next:o})=>{let n={type:"array",items:o(r)};return e&&(n.minItems=e.value),t&&(n.maxItems=t.value),n},rs=({items:e,_def:{rest:t}},{next:r})=>({type:"array",prefixItems:e.map(r),items:t===null?{not:{}}:r(t)}),os=({isEmail:e,isURL:t,minLength:r,maxLength:o,isUUID:n,isCUID:i,isCUID2:a,isULID:p,isIP:d,isEmoji:c,isDatetime:m,_def:{checks:l}})=>{let u=l.find(O=>O.kind==="regex"),S=l.find(O=>O.kind==="datetime"),T=u?u.regex:S?S.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}:\\d{2})|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$"):void 0,z={type:"string"},h={"date-time":m,email:e,url:t,uuid:n,cuid:i,cuid2:a,ulid:p,ip:d,emoji:c};for(let O in h)if(h[O]){z.format=O;break}return r!==null&&(z.minLength=r),o!==null&&(z.maxLength=o),T&&(z.pattern=T.source),z},ns=({isInt:e,maxValue:t,minValue:r,_def:{checks:o}})=>{let n=o.find(l=>l.kind==="min"),i=r===null?e?Number.MIN_SAFE_INTEGER:-Number.MAX_VALUE:r,a=n?n.inclusive:!0,p=o.find(l=>l.kind==="max"),d=t===null?e?Number.MAX_SAFE_INTEGER:Number.MAX_VALUE:t,c=p?p.inclusive:!0,m={type:e?"integer":"number",format:e?"int64":"double"};return a?m.minimum=i:m.exclusiveMinimum=i,c?m.maximum=d:m.exclusiveMaximum=d,m},rt=({shape:e},t)=>he(t,e),ss=e=>{let t=Array.isArray(e.type)?e.type[0]:e.type;return En?.[t]},qr=e=>{let t=typeof e.type=="string"?[e.type]:e.type||[];return t.includes("null")?t:t.concat("null")},is=(e,{isResponse:t,next:r})=>{let o=r(e.innerType()),{effect:n}=e._def;if(t&&n.type==="transform"&&ot(o)){let i=Fe(e,ss(o));return i&&["number","string","boolean"].includes(i)?{type:i}:r(x.any())}if(!t&&n.type==="preprocess"&&ot(o)){let{type:i,...a}=o;return{...a,format:`${a.format||i} (preprocessed)`}}return o},as=({_def:e},{isResponse:t,next:r})=>r(e[t?"out":"in"]),ps=(e,{next:t})=>t(e.unwrap()),cs=(e,{next:t,makeRef:r})=>r(e,()=>t(e.schema)),ds=(e,{next:t})=>t(e.unwrap().shape.raw),$r=e=>e.length?Ne(Zn(Pn(1,e.length+1).map(t=>`example${t}`),he(Ur("value"),e))):void 0,Vr=(e,t,r=[])=>Hr(D,he(In(o=>Mr(o)==="Object",nt(r))),$r)({schema:e,variant:t?"parsed":"original",validate:!0}),ls=(e,t)=>Hr(D,xn(bn(t)),An(t),$r)({schema:e,variant:"original",validate:!0}),re=e=>e instanceof x.ZodObject?e:e instanceof x.ZodBranded?re(e.unwrap()):e instanceof x.ZodUnion||e instanceof x.ZodDiscriminatedUnion?e.options.map(t=>re(t)).reduce((t,r)=>t.merge(r.partial()),x.object({})):e instanceof x.ZodEffects?re(e._def.schema):e instanceof x.ZodPipeline?re(e._def.in):re(e._def.left).merge(re(e._def.right)),Gr=({path:e,method:t,schema:r,inputSources:o,makeRef:n,composition:i,brandHandling:a,description:p=`${t.toUpperCase()} ${e} Parameter`})=>{let{shape:d}=re(r),c=vn(e),m=o.includes("query"),l=o.includes("params"),u=o.includes("headers"),S=h=>l&&c.includes(h),T=h=>u&&ft(h);return Object.keys(d).map(h=>({name:h,location:S(h)?"path":T(h)?"header":m?"query":void 0})).filter(h=>h.location!==void 0).map(({name:h,location:O})=>{let $=te(d[h],{rules:{...a,...wt},onEach:It,onMissing:Zt,ctx:{isResponse:!1,makeRef:n,path:e,method:t}}),ie=i==="components"?n(d[h],$,E(p,h)):$;return{name:h,in:O,required:!d[h].isOptional(),description:$.description||p,schema:ie,examples:ls(r,h)}})},wt={ZodString:os,ZodNumber:ns,ZodBigInt:Wn,ZodBoolean:Jn,ZodNull:Gn,ZodArray:ts,ZodTuple:rs,ZodRecord:es,ZodObject:Vn,ZodLiteral:$n,ZodIntersection:Kn,ZodUnion:Un,ZodAny:Nn,ZodDefault:jn,ZodEnum:kr,ZodNativeEnum:kr,ZodEffects:is,ZodOptional:Fn,ZodNullable:qn,ZodDiscriminatedUnion:Hn,ZodBranded:ps,ZodDate:Qn,ZodCatch:Ln,ZodPipeline:as,ZodLazy:cs,ZodReadonly:Bn,[j]:Mn,[me]:kn,[J]:Yn,[Q]:_n,[K]:ds},It=(e,{isResponse:t,prev:r})=>{if(zt(r))return{};let{description:o}=e,n=e instanceof x.ZodLazy,i=r.type!==void 0,a=t&&Ce(e),p=!n&&i&&!a&&e.isNullable(),d=n?[]:D({schema:e,variant:t?"parsed":"original",validate:!0}),c={};return o&&(c.description=o),p&&(c.type=qr(r)),d.length&&(c.examples=d.slice()),c},Zt=(e,t)=>oe.fail(new Z({message:`Zod type ${e.constructor.name} is unsupported.`,...t})),Ct=(e,t)=>{if(zt(e))return e;let r={...e};return r.properties&&(r.properties=nt(t,r.properties)),r.examples&&(r.examples=r.examples.map(o=>nt(t,o))),r.required&&(r.required=r.required.filter(o=>!t.includes(o))),r.allOf&&(r.allOf=r.allOf.map(o=>Ct(o,t))),r.oneOf&&(r.oneOf=r.oneOf.map(o=>Ct(o,t))),r},_r=e=>zt(e)?e:nt(["examples"],e),Yr=({method:e,path:t,schema:r,mimeTypes:o,variant:n,makeRef:i,composition:a,hasMultipleStatusCodes:p,statusCode:d,brandHandling:c,description:m=`${e.toUpperCase()} ${t} ${gt(n)} response ${p?d:""}`.trim()})=>{let l=_r(te(r,{rules:{...c,...wt},onEach:It,onMissing:Zt,ctx:{isResponse:!0,makeRef:i,path:t,method:e}})),u={schema:a==="components"?i(r,l,E(m)):l,examples:Vr(r,!0)};return{description:m,content:Ne(st(o,[u]))}},ms=()=>({type:"http",scheme:"basic"}),us=({format:e})=>{let t={type:"http",scheme:"bearer"};return e&&(t.bearerFormat=e),t},fs=({name:e},t)=>{let r={type:"apiKey",in:"query",name:e};return t?.includes("body")&&(t?.includes("query")?(r["x-in-alternative"]="body",r.description=`${e} CAN also be supplied within the request body`):(r["x-in-actual"]="body",r.description=`${e} MUST be supplied within the request body instead of query`)),r},ys=({name:e})=>({type:"apiKey",in:"header",name:e}),gs=({name:e})=>({type:"apiKey",in:"cookie",name:e}),hs=({url:e})=>({type:"openIdConnect",openIdConnectUrl:e}),xs=({flows:e={}})=>({type:"oauth2",flows:he(t=>({...t,scopes:t.scopes||{}}),Cn(Sn,e))}),Qr=(e,t)=>{let r={basic:ms,bearer:us,input:fs,header:ys,cookie:gs,openid:hs,oauth2:xs};return Qe(e,o=>r[o.type](o,t))},it=e=>"or"in e?e.or.map(t=>"and"in t?Tn(he(({name:r,scopes:o})=>Ur(r,o),t.and)):{[t.name]:t.scopes}):"and"in e?it(St(e)):it({or:[e]}),Jr=({method:e,path:t,schema:r,mimeTypes:o,makeRef:n,composition:i,brandHandling:a,paramNames:p,description:d=`${e.toUpperCase()} ${t} Request body`})=>{let c=_r(Ct(te(r,{rules:{...a,...wt},onEach:It,onMissing:Zt,ctx:{isResponse:!1,makeRef:n,path:t,method:e}}),p)),m={schema:i==="components"?n(r,c,E(d)):c,examples:Vr(r,!1,p)};return{description:d,content:Ne(st(o,[m]))}},Wr=e=>Object.keys(e).map(t=>{let r=e[t],o={name:t,description:typeof r=="string"?r:r.description};return typeof r=="object"&&r.url&&(o.externalDocs={url:r.url}),o}),Et=e=>e.length<=Nr?e:e.slice(0,Nr-1)+"\u2026";var vt=class extends Ss{lastSecuritySchemaIds=new Map;lastOperationIdSuffixes=new Map;responseVariants=Ts(X);references=new Map;makeRef(t,r,o=this.references.get(t)){return o||(o=`Schema${this.references.size+1}`,this.references.set(t,o),typeof r=="function"&&(r=r())),typeof r=="object"&&this.addSchema(o,r),{$ref:`#/components/schemas/${o}`}}ensureUniqOperationId(t,r,o){let n=o||E(r,t),i=this.lastOperationIdSuffixes.get(n);return i===void 0?(this.lastOperationIdSuffixes.set(n,1),n):(o&&bs.fail(new Z({message:`Duplicated operationId: "${o}"`,method:r,isResponse:!1,path:t})),i++,this.lastOperationIdSuffixes.set(n,i),`${n}${i}`)}ensureUniqSecuritySchemaName(t){let r=JSON.stringify(t);for(let n in this.rootDoc.components?.securitySchemes||{})if(r===JSON.stringify(this.rootDoc.components?.securitySchemes?.[n]))return n;let o=(this.lastSecuritySchemaIds.get(t.type)||0)+1;return this.lastSecuritySchemaIds.set(t.type,o),`${t.type.toUpperCase()}_${o}`}constructor({routing:t,config:r,title:o,version:n,serverUrl:i,descriptions:a,brandHandling:p,hasSummaryFromDescription:d=!0,composition:c="inline"}){super(),this.addInfo({title:o,version:n});for(let l of typeof i=="string"?[i]:i)this.addServer({url:l});ee({routing:t,onEndpoint:(l,u,S)=>{let T=S,z={path:u,method:T,endpoint:l,composition:c,brandHandling:p,makeRef:this.makeRef.bind(this)},[h,O]=["short","long"].map(l.getDescription.bind(l)),$=h?Et(h):d&&O?Et(O):void 0,ie=l.getTags(),be=r.inputSources?.[T]||mt[T],ae=this.ensureUniqOperationId(u,T,l.getOperationId(T)),Se=Gr({...z,inputSources:be,schema:l.getSchema("input"),description:a?.requestParameter?.call(null,{method:T,path:u,operationId:ae})}),Me={};for(let N of this.responseVariants){let V=l.getResponses(N);for(let{mimeTypes:Te,schema:P,statusCodes:C}of V)for(let w of C)Me[w]=Yr({...z,variant:N,schema:P,mimeTypes:Te,statusCode:w,hasMultipleStatusCodes:V.length>1||C.length>1,description:a?.[`${N}Response`]?.call(null,{method:T,path:u,operationId:ae,statusCode:w})})}let lt=be.includes("body")?Jr({...z,paramNames:Os("name",Se),schema:l.getSchema("input"),mimeTypes:l.getMimeTypes("input"),description:a?.requestBody?.call(null,{method:T,path:u,operationId:ae})}):void 0,Ue=it(Qe(Qr(l.getSecurity(),be),N=>{let V=this.ensureUniqSecuritySchemaName(N),Te=["oauth2","openIdConnect"].includes(N.type)?l.getScopes().slice():[];return this.addSecurityScheme(V,N),{name:V,scopes:Te}}));this.addPath(Fr(u),{[T]:{operationId:ae,summary:$,description:O,tags:ie.length>0?ie:void 0,parameters:Se.length>0?Se:void 0,requestBody:lt,security:Ue.length>0?Ue:void 0,responses:Me}})}}),this.rootDoc.tags=r.tags?Wr(r.tags):[]}};import{createRequest as Rs,createResponse as As}from"node-mocks-http";var Ps=e=>Rs({...e,headers:{"content-type":R.json,...e?.headers}}),Cs=e=>As(e),zs=e=>{let t={warn:[],error:[],info:[],debug:[]};return new Proxy(e||{},{get(r,o,n){return o==="_getLogs"?()=>t:lr(o)?(...i)=>t[o].push(i):Reflect.get(r,o,n)}})},Xr=({requestProps:e,responseOptions:t,configProps:r,loggerProps:o})=>{let n=Ps(e),i=Cs({req:n,...t});i.req=t?.req||n,n.res=i;let a=zs(o),p={cors:!1,logger:a,...r};return{requestMock:n,responseMock:i,loggerMock:a,configMock:p}},ws=async({endpoint:e,...t})=>{let{requestMock:r,responseMock:o,loggerMock:n,configMock:i}=Xr(t);return await e.execute({request:r,response:o,config:i,logger:n}),{requestMock:r,responseMock:o,loggerMock:n}},Is=async({middleware:e,options:t={},...r})=>{let{requestMock:o,responseMock:n,loggerMock:i,configMock:a}=Xr(r),p=De(o,a.inputSources),d=await e.execute({request:o,response:n,logger:i,input:p,options:t});return{requestMock:o,responseMock:n,loggerMock:i,output:d}};import v from"typescript";import M from"typescript";import{chain as eo,toPairs as to}from"ramda";var s=M.factory,B=[s.createModifier(M.SyntaxKind.ExportKeyword)],Zs=[s.createModifier(M.SyntaxKind.AsyncKeyword)],Es=[s.createModifier(M.SyntaxKind.PublicKeyword),s.createModifier(M.SyntaxKind.ReadonlyKeyword)],ro=[s.createModifier(M.SyntaxKind.ProtectedKeyword),s.createModifier(M.SyntaxKind.ReadonlyKeyword)],jt=s.createTemplateHead(""),xe=s.createTemplateTail(""),Lt=s.createTemplateMiddle(" "),Nt=e=>s.createTemplateLiteralType(jt,e.map((t,r)=>s.createTemplateLiteralTypeSpan(s.createTypeReferenceNode(t),r===e.length-1?xe:Lt))),kt=Nt(["M","P"]),at=(e,t,r)=>s.createParameterDeclaration(r,void 0,e,void 0,t,void 0),pt=(e,t)=>eo(([r,o])=>[at(s.createIdentifier(r),o,t)],to(e)),Mt=(e,t)=>s.createExpressionWithTypeArguments(s.createIdentifier("Record"),[typeof e=="number"?s.createKeywordTypeNode(e):s.createTypeReferenceNode(e),s.createKeywordTypeNode(t)]),oo=e=>s.createConstructorDeclaration(void 0,e,s.createBlock([])),no=(e,t)=>s.createPropertySignature(void 0,e,void 0,s.createTypeReferenceNode(t)),q=(e,t,r)=>s.createVariableDeclarationList([s.createVariableDeclaration(e,void 0,r,t)],M.NodeFlags.Const),Ut=(e,t)=>s.createTypeAliasDeclaration(B,e,void 0,s.createUnionTypeNode(t.map(r=>s.createLiteralTypeNode(s.createStringLiteral(r))))),ct=(e,t)=>s.createTypeAliasDeclaration(B,e,void 0,t),so=(e,t,r)=>s.createPropertyDeclaration(Es,e,void 0,t,r),io=(e,t,r)=>s.createClassDeclaration(B,e,void 0,void 0,[t,...r]),ao=(e,t)=>s.createTypeReferenceNode("Promise",[s.createIndexedAccessTypeNode(s.createTypeReferenceNode(e),t)]),po=()=>s.createTypeReferenceNode("Promise",[s.createKeywordTypeNode(M.SyntaxKind.AnyKeyword)]),co=(e,t,r)=>s.createInterfaceDeclaration(B,e,void 0,t,r),vs=eo(([e,t])=>[s.createTypeParameterDeclaration([],e,s.createTypeReferenceNode(t))]),lo=e=>vs(to(e)),Ht=(e,t,r)=>s.createArrowFunction(r?Zs:void 0,void 0,e.map(o=>at(o)),void 0,void 0,t),Dt=(e,t,r)=>s.createCallExpression(s.createPropertyAccessExpression(s.createCallExpression(s.createPropertyAccessExpression(s.createIdentifier("Object"),"keys"),void 0,[e]),"reduce"),void 0,[s.createArrowFunction(void 0,void 0,pt({acc:void 0,key:void 0}),void 0,void 0,t),r]),mo=(...e)=>`"${e.join(" ")}"`;var uo=["get","post","put","delete","patch"];import y from"typescript";import{z as Bt}from"zod";import b from"typescript";var{factory:dt}=b,Kt=(e,t)=>{b.addSyntheticLeadingComment(e,b.SyntaxKind.MultiLineCommentTrivia,`* ${t} `,!0)},ne=(e,t,r)=>{let o=dt.createTypeAliasDeclaration(void 0,dt.createIdentifier(t),void 0,e);return r&&Kt(o,r),o},Ft=(e,t)=>{let r=b.createSourceFile("print.ts","",b.ScriptTarget.Latest,!1,b.ScriptKind.TS);return b.createPrinter(t).printNode(b.EmitHint.Unspecified,e,r)},js=/^[A-Za-z_$][A-Za-z0-9_$]*$/,fo=e=>js.test(e)?dt.createIdentifier(e):dt.createStringLiteral(e),Ls=[b.SyntaxKind.AnyKeyword,b.SyntaxKind.BigIntKeyword,b.SyntaxKind.BooleanKeyword,b.SyntaxKind.NeverKeyword,b.SyntaxKind.NumberKeyword,b.SyntaxKind.ObjectKeyword,b.SyntaxKind.StringKeyword,b.SyntaxKind.SymbolKeyword,b.SyntaxKind.UndefinedKeyword,b.SyntaxKind.UnknownKeyword,b.SyntaxKind.VoidKeyword],yo=e=>Ls.includes(e.kind);var{factory:f}=y,Ns={[y.SyntaxKind.AnyKeyword]:"",[y.SyntaxKind.BigIntKeyword]:BigInt(0),[y.SyntaxKind.BooleanKeyword]:!1,[y.SyntaxKind.NumberKeyword]:0,[y.SyntaxKind.ObjectKeyword]:{},[y.SyntaxKind.StringKeyword]:"",[y.SyntaxKind.UndefinedKeyword]:void 0},ks=({value:e})=>f.createLiteralTypeNode(typeof e=="number"?f.createNumericLiteral(e):typeof e=="boolean"?e?f.createTrue():f.createFalse():f.createStringLiteral(e)),Ms=({shape:e},{isResponse:t,next:r,optionalPropStyle:{withQuestionMark:o}})=>{let n=Object.entries(e).map(([i,a])=>{let p=t&&Ce(a)?a instanceof Bt.ZodOptional:a.isOptional(),d=f.createPropertySignature(void 0,fo(i),p&&o?f.createToken(y.SyntaxKind.QuestionToken):void 0,r(a));return a.description&&Kt(d,a.description),d});return f.createTypeLiteralNode(n)},Us=({element:e},{next:t})=>f.createArrayTypeNode(t(e)),Hs=({options:e})=>f.createUnionTypeNode(e.map(t=>f.createLiteralTypeNode(f.createStringLiteral(t)))),go=({options:e},{next:t})=>{let r=new Map;for(let o of e){let n=t(o);r.set(yo(n)?n.kind:n,n)}return f.createUnionTypeNode(Array.from(r.values()))},Ds=e=>Ns?.[e.kind],Ks=(e,{next:t,isResponse:r})=>{let o=t(e.innerType());if(r&&e._def.effect.type==="transform"){let n=Fe(e,Ds(o)),i={number:y.SyntaxKind.NumberKeyword,bigint:y.SyntaxKind.BigIntKeyword,boolean:y.SyntaxKind.BooleanKeyword,string:y.SyntaxKind.StringKeyword,undefined:y.SyntaxKind.UndefinedKeyword,object:y.SyntaxKind.ObjectKeyword};return f.createKeywordTypeNode(n&&i[n]||y.SyntaxKind.AnyKeyword)}return o},Fs=e=>f.createUnionTypeNode(Object.values(e.enum).map(t=>f.createLiteralTypeNode(typeof t=="number"?f.createNumericLiteral(t):f.createStringLiteral(t)))),Bs=(e,{next:t,optionalPropStyle:{withUndefined:r}})=>{let o=t(e.unwrap());return r?f.createUnionTypeNode([o,f.createKeywordTypeNode(y.SyntaxKind.UndefinedKeyword)]):o},qs=(e,{next:t})=>f.createUnionTypeNode([t(e.unwrap()),f.createLiteralTypeNode(f.createNull())]),$s=({items:e,_def:{rest:t}},{next:r})=>f.createTupleTypeNode(e.map(r).concat(t===null?[]:f.createRestTypeNode(r(t)))),Vs=({keySchema:e,valueSchema:t},{next:r})=>f.createExpressionWithTypeArguments(f.createIdentifier("Record"),[e,t].map(r)),Gs=({_def:{left:e,right:t}},{next:r})=>{let o=[e,t].map(r);return o.every(y.isTypeLiteralNode)?f.createTypeLiteralNode(o.flatMap(({members:i})=>i)):f.createIntersectionTypeNode(o)},_s=({_def:e},{next:t})=>t(e.innerType),se=e=>()=>f.createKeywordTypeNode(e),Ys=(e,{next:t})=>t(e.unwrap()),Qs=(e,{next:t})=>t(e.unwrap()),Js=({_def:e},{next:t})=>t(e.innerType),Ws=({_def:e},{next:t,isResponse:r})=>t(e[r?"out":"in"]),Xs=()=>f.createLiteralTypeNode(f.createNull()),ei=(e,{makeAlias:t,next:r})=>t(e,()=>r(e.schema)),ti=e=>{let t=e.unwrap(),r=f.createKeywordTypeNode(y.SyntaxKind.StringKeyword),o=f.createTypeReferenceNode("Buffer"),n=f.createUnionTypeNode([r,o]);return t instanceof Bt.ZodString?r:t instanceof Bt.ZodUnion?n:o},ri=(e,{next:t})=>t(e.unwrap().shape.raw),oi={ZodString:se(y.SyntaxKind.StringKeyword),ZodNumber:se(y.SyntaxKind.NumberKeyword),ZodBigInt:se(y.SyntaxKind.BigIntKeyword),ZodBoolean:se(y.SyntaxKind.BooleanKeyword),ZodAny:se(y.SyntaxKind.AnyKeyword),[Q]:se(y.SyntaxKind.StringKeyword),[J]:se(y.SyntaxKind.StringKeyword),ZodNull:Xs,ZodArray:Us,ZodTuple:$s,ZodRecord:Vs,ZodObject:Ms,ZodLiteral:ks,ZodIntersection:Gs,ZodUnion:go,ZodDefault:_s,ZodEnum:Hs,ZodNativeEnum:Fs,ZodEffects:Ks,ZodOptional:Bs,ZodNullable:qs,ZodDiscriminatedUnion:go,ZodBranded:Ys,ZodCatch:Js,ZodPipeline:Ws,ZodLazy:ei,ZodReadonly:Qs,[j]:ti,[K]:ri},ke=(e,{brandHandling:t,ctx:r})=>te(e,{rules:{...t,...oi},onMissing:()=>f.createKeywordTypeNode(y.SyntaxKind.AnyKeyword),ctx:r});var qt=class{program=[];usage=[];registry=new Map;paths=[];aliases=new Map;ids={pathType:s.createIdentifier("Path"),methodType:s.createIdentifier("Method"),methodPathType:s.createIdentifier("MethodPath"),inputInterface:s.createIdentifier("Input"),posResponseInterface:s.createIdentifier("PositiveResponse"),negResponseInterface:s.createIdentifier("NegativeResponse"),responseInterface:s.createIdentifier("Response"),jsonEndpointsConst:s.createIdentifier("jsonEndpoints"),endpointTagsConst:s.createIdentifier("endpointTags"),providerType:s.createIdentifier("Provider"),implementationType:s.createIdentifier("Implementation"),clientClass:s.createIdentifier("ExpressZodAPIClient"),keyParameter:s.createIdentifier("key"),pathParameter:s.createIdentifier("path"),paramsArgument:s.createIdentifier("params"),methodParameter:s.createIdentifier("method"),accumulator:s.createIdentifier("acc"),provideMethod:s.createIdentifier("provide"),implementationArgument:s.createIdentifier("implementation"),headersProperty:s.createIdentifier("headers"),hasBodyConst:s.createIdentifier("hasBody"),undefinedValue:s.createIdentifier("undefined"),bodyProperty:s.createIdentifier("body"),responseConst:s.createIdentifier("response"),searchParamsConst:s.createIdentifier("searchParams"),exampleImplementationConst:s.createIdentifier("exampleImplementation"),clientConst:s.createIdentifier("client")};interfaces=[];makeAlias(t,r){let o=this.aliases.get(t)?.name?.text;if(!o){o=`Type${this.aliases.size+1}`;let n=s.createLiteralTypeNode(s.createNull());this.aliases.set(t,ne(n,o)),this.aliases.set(t,ne(r(),o))}return s.createTypeReferenceNode(o)}constructor({routing:t,brandHandling:r,variant:o="client",splitResponse:n=!1,optionalPropStyle:i={withQuestionMark:!0,withUndefined:!0}}){ee({routing:t,onEndpoint:(P,C,w)=>{let pe={makeAlias:this.makeAlias.bind(this),optionalPropStyle:i},Oe=E(w,C,"input"),Re=ke(P.getSchema("input"),{brandHandling:r,ctx:{...pe,isResponse:!1}}),I=n?E(w,C,"positive.response"):void 0,$t=P.getSchema("positive"),Vt=n?ke($t,{brandHandling:r,ctx:{...pe,isResponse:!0}}):void 0,Ae=n?E(w,C,"negative.response"):void 0,Gt=P.getSchema("negative"),_t=n?ke(Gt,{brandHandling:r,ctx:{...pe,isResponse:!0}}):void 0,Yt=E(w,C,"response"),ho=I&&Ae?s.createUnionTypeNode([s.createTypeReferenceNode(I),s.createTypeReferenceNode(Ae)]):ke($t.or(Gt),{brandHandling:r,ctx:{...pe,isResponse:!0}});this.program.push(ne(Re,Oe)),Vt&&I&&this.program.push(ne(Vt,I)),_t&&Ae&&this.program.push(ne(_t,Ae)),this.program.push(ne(ho,Yt)),w!=="options"&&(this.paths.push(C),this.registry.set({method:w,path:C},{input:Oe,positive:I,negative:Ae,response:Yt,isJson:P.getMimeTypes("positive").includes(R.json),tags:P.getTags()}))}}),this.program.unshift(...this.aliases.values()),this.program.push(Ut(this.ids.pathType,this.paths)),this.program.push(Ut(this.ids.methodType,uo)),this.program.push(ct(this.ids.methodPathType,Nt([this.ids.methodType,this.ids.pathType])));let a=[s.createHeritageClause(v.SyntaxKind.ExtendsKeyword,[Mt(this.ids.methodPathType,v.SyntaxKind.AnyKeyword)])];this.interfaces.push({id:this.ids.inputInterface,kind:"input",props:[]}),n&&this.interfaces.push({id:this.ids.posResponseInterface,kind:"positive",props:[]},{id:this.ids.negResponseInterface,kind:"negative",props:[]}),this.interfaces.push({id:this.ids.responseInterface,kind:"response",props:[]});let p=[],d=[];for(let[{method:P,path:C},{isJson:w,tags:pe,...Oe}]of this.registry){let Re=mo(P,C);for(let I of this.interfaces)I.kind in Oe&&I.props.push(no(Re,Oe[I.kind]));o!=="types"&&(w&&p.push(s.createPropertyAssignment(Re,s.createTrue())),d.push(s.createPropertyAssignment(Re,s.createArrayLiteralExpression(pe.map(I=>s.createStringLiteral(I))))))}for(let{id:P,props:C}of this.interfaces)this.program.push(co(P,a,C));if(o==="types")return;let c=s.createVariableStatement(B,q(this.ids.jsonEndpointsConst,s.createObjectLiteralExpression(p))),m=s.createVariableStatement(B,q(this.ids.endpointTagsConst,s.createObjectLiteralExpression(d))),l=ct(this.ids.providerType,s.createFunctionTypeNode(lo({M:this.ids.methodType,P:this.ids.pathType}),pt({method:s.createTypeReferenceNode("M"),path:s.createTypeReferenceNode("P"),params:s.createIndexedAccessTypeNode(s.createTypeReferenceNode(this.ids.inputInterface),kt)}),ao(this.ids.responseInterface,kt))),u=ct(this.ids.implementationType,s.createFunctionTypeNode(void 0,pt({method:s.createTypeReferenceNode(this.ids.methodType),path:s.createKeywordTypeNode(v.SyntaxKind.StringKeyword),params:Mt(v.SyntaxKind.StringKeyword,v.SyntaxKind.AnyKeyword)}),po())),S=s.createTemplateExpression(s.createTemplateHead(":"),[s.createTemplateSpan(this.ids.keyParameter,xe)]),T=Dt(this.ids.paramsArgument,s.createCallExpression(s.createPropertyAccessExpression(this.ids.accumulator,"replace"),void 0,[S,s.createElementAccessExpression(this.ids.paramsArgument,this.ids.keyParameter)]),this.ids.pathParameter),z=Dt(this.ids.paramsArgument,s.createConditionalExpression(s.createBinaryExpression(s.createCallExpression(s.createPropertyAccessExpression(this.ids.pathParameter,"indexOf"),void 0,[S]),v.SyntaxKind.GreaterThanEqualsToken,s.createNumericLiteral(0)),void 0,this.ids.accumulator,void 0,s.createObjectLiteralExpression([s.createSpreadAssignment(this.ids.accumulator),s.createPropertyAssignment(s.createComputedPropertyName(this.ids.keyParameter),s.createElementAccessExpression(this.ids.paramsArgument,this.ids.keyParameter))])),s.createObjectLiteralExpression()),h=io(this.ids.clientClass,oo([at(this.ids.implementationArgument,s.createTypeReferenceNode(this.ids.implementationType),ro)]),[so(this.ids.provideMethod,s.createTypeReferenceNode(this.ids.providerType),Ht([this.ids.methodParameter,this.ids.pathParameter,this.ids.paramsArgument],s.createCallExpression(s.createPropertyAccessExpression(s.createThis(),this.ids.implementationArgument),void 0,[this.ids.methodParameter,T,z]),!0))]);this.program.push(c,m,l,u,h);let O=s.createPropertyAssignment(this.ids.methodParameter,s.createCallExpression(s.createPropertyAccessExpression(this.ids.methodParameter,"toUpperCase"),void 0,void 0)),$=s.createPropertyAssignment(this.ids.headersProperty,s.createConditionalExpression(this.ids.hasBodyConst,void 0,s.createObjectLiteralExpression([s.createPropertyAssignment(s.createStringLiteral("Content-Type"),s.createStringLiteral(R.json))]),void 0,this.ids.undefinedValue)),ie=s.createPropertyAssignment(this.ids.bodyProperty,s.createConditionalExpression(this.ids.hasBodyConst,void 0,s.createCallExpression(s.createPropertyAccessExpression(s.createIdentifier("JSON"),"stringify"),void 0,[this.ids.paramsArgument]),void 0,this.ids.undefinedValue)),be=s.createVariableStatement(void 0,q(this.ids.responseConst,s.createAwaitExpression(s.createCallExpression(s.createIdentifier("fetch"),void 0,[s.createTemplateExpression(s.createTemplateHead("https://example.com"),[s.createTemplateSpan(this.ids.pathParameter,s.createTemplateMiddle("")),s.createTemplateSpan(this.ids.searchParamsConst,xe)]),s.createObjectLiteralExpression([O,$,ie])])))),ae=s.createVariableStatement(void 0,q(this.ids.hasBodyConst,s.createLogicalNot(s.createCallExpression(s.createPropertyAccessExpression(s.createArrayLiteralExpression([s.createStringLiteral("get"),s.createStringLiteral("delete")]),"includes"),void 0,[this.ids.methodParameter])))),Se=s.createVariableStatement(void 0,q(this.ids.searchParamsConst,s.createConditionalExpression(this.ids.hasBodyConst,void 0,s.createStringLiteral(""),void 0,s.createTemplateExpression(s.createTemplateHead("?"),[s.createTemplateSpan(s.createNewExpression(s.createIdentifier("URLSearchParams"),void 0,[this.ids.paramsArgument]),xe)])))),[Me,lt]=["json","text"].map(P=>s.createReturnStatement(s.createCallExpression(s.createPropertyAccessExpression(this.ids.responseConst,P),void 0,void 0))),Ue=s.createIfStatement(s.createBinaryExpression(s.createTemplateExpression(jt,[s.createTemplateSpan(this.ids.methodParameter,Lt),s.createTemplateSpan(this.ids.pathParameter,xe)]),v.SyntaxKind.InKeyword,this.ids.jsonEndpointsConst),s.createBlock([Me])),N=s.createVariableStatement(B,q(this.ids.exampleImplementationConst,Ht([this.ids.methodParameter,this.ids.pathParameter,this.ids.paramsArgument],s.createBlock([ae,Se,be,Ue,lt]),!0),s.createTypeReferenceNode(this.ids.implementationType))),V=s.createExpressionStatement(s.createCallExpression(s.createPropertyAccessExpression(this.ids.clientConst,this.ids.provideMethod),void 0,[s.createStringLiteral("get"),s.createStringLiteral("/v1/user/retrieve"),s.createObjectLiteralExpression([s.createPropertyAssignment("id",s.createStringLiteral("10"))])])),Te=s.createVariableStatement(void 0,q(this.ids.clientConst,s.createNewExpression(this.ids.clientClass,void 0,[this.ids.exampleImplementationConst])));this.usage.push(N,Te,V)}printUsage(t){return this.usage.length?this.usage.map(r=>typeof r=="string"?r:Ft(r,t)).join(`
`):void 0}print(t){let r=this.printUsage(t),o=r&&v.addSyntheticLeadingComment(v.addSyntheticLeadingComment(s.createEmptyStatement(),v.SyntaxKind.SingleLineCommentTrivia," Usage example:"),v.SyntaxKind.MultiLineCommentTrivia,`
${r}`);return this.program.concat(o||[]).map((n,i)=>Ft(n,i<this.program.length?t:{...t,omitTrailingSemicolon:!0})).join(`

`)}async printFormatted({printerOptions:t,format:r}={}){let o=r;if(!o)try{let a=(await ge("prettier")).format;o=p=>a(p,{filepath:"client.ts"})}catch{}let n=this.printUsage(t);this.usage=n&&o?[await o(n)]:this.usage;let i=this.print(t);return o?o(i):i}};var ni={dateIn:Wt,dateOut:Xt,file:Ve,upload:rr,raw:tr};export{ve as BuiltinLogger,je as DependsOnMethod,vt as Documentation,Z as DocumentationError,Ee as EndpointsFactory,k as InputValidationError,qt as Integration,F as Middleware,Pe as MissingPeerError,G as OutputValidationError,Ie as ResultHandler,ce as RoutingError,Le as ServeStatic,Go as arrayEndpointsFactory,Rt as arrayResultHandler,yn as attachRouting,ko as createConfig,gn as createServer,Vo as defaultEndpointsFactory,Ze as defaultResultHandler,ni as ez,D as getExamples,H as getMessageFromError,Ke as getStatusCodeFromError,ws as testEndpoint,Is as testMiddleware};
